<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Top 3 Cheapest Items (API personnalisÃ©e)</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; }
        table { width: 95%; margin: 20px auto; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #333; }
        input[type=text] { padding: 4px; width: 250px; }
        button { padding: 6px 12px; margin-left: 10px; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Top 3 Cheapest Items (API personnalisÃ©e)</h2>
    ðŸ”‘ ClÃ© API Torn :
    <input type="text" id="apiKey" placeholder="Votre clÃ© API Torn">
    <button onclick="loadPrices()">ðŸ”„ Refresh maintenant</button>
    <div id="error" class="error"></div>
    <table>
        <thead>
            <tr><th>Item</th><th>Prix 1</th><th>Prix 2</th><th>Prix 3</th></tr>
        </thead>
        <tbody id="pricesTable">
            <tr><td>Donator Pack</td><td colspan="3" id="dp">Chargement...</td></tr>
            <tr><td>Xanax</td><td colspan="3" id="xanax">Chargement...</td></tr>
            <tr><td>Stat Enhancer</td><td colspan="3" id="stat">Chargement...</td></tr>
        </tbody>
    </table>

    <script>
        const items = {
            283: "dp",
            206: "xanax",
            209: "stat"
        };

        document.getElementById("apiKey").value = localStorage.getItem("tornApiKey") || "";

        async function loadPrices() {
            const key = document.getElementById("apiKey").value.trim();
            localStorage.setItem("tornApiKey", key);
            document.getElementById("error").textContent = "";

            if (!key) {
                document.getElementById("error").textContent = "Veuillez entrer votre clÃ© API Torn.";
                return;
            }

            for (const [itemId, htmlId] of Object.entries(items)) {
                try {
                    const res = await fetch(`/api/proxy?itemId=${itemId}&key=${key}`);
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);
                    const listings = data.itemmarket.listings || [];
                    const top3 = listings.slice(0, 3).map(l => 
                        `<a href="https://www.torn.com/imarket.php#/p=shop&type=inventory&searchname=&id=${itemId}" target="_blank">${l.price.toLocaleString()}$ (${l.amount})</a>`
                    );
                    document.getElementById(htmlId).innerHTML = `<td>${top3[0] || "N/A"}</td><td>${top3[1] || "N/A"}</td><td>${top3[2] || "N/A"}</td>`;
                } catch (e) {
                    document.getElementById(htmlId).innerHTML = `<td colspan="3">Erreur de chargement</td>`;
                }
            }
        }
    </script>
</body>
</html>